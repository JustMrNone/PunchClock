<!-- Employee View Tab -->
<div id="employee-view" class="tab-content">
    <header class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Employee Time Tracking</h1>
            <p class="text-gray-600">Detailed view of employee working hours</p>
        </div>
        <div class="flex items-center space-x-4">
            <!-- NEW DROPDOWN with unique styling -->
            <div class="relative" id="new-dropdown-container" style="min-width: 200px;">
                <select id="new-employee-select" style="width: 100%; height: 40px; padding: 8px 30px 8px 40px; background-color: #f3f4ff; border: 2px solid #6366f1; border-radius: 8px; font-weight: 500; color: #333; cursor: pointer; appearance: none;">
                    <option value="">Choose Employee</option>
                    <!-- Options will be populated by JS -->
                </select>
                <div style="position: absolute; top: 10px; left: 10px;">ðŸ‘¤</div>
                <div style="position: absolute; top: 10px; right: 10px;">â–¼</div>
            </div>

            <button class="p-2 bg-gray-100 rounded-lg hover:bg-gray-200">
                <i class="fas fa-calendar-alt text-gray-600"></i>
            </button>
        </div>
    </header>

    <!-- Employee Summary -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-xl p-6 time-card">
            <div class="flex items-center">
                <div id="employee-initials" class="w-16 h-16 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold text-2xl mr-4">--</div>
                <div>
                    <h3 id="employee-name" class="text-xl font-semibold text-gray-800">Select an employee</h3>
                    <p id="dep">--</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl p-6 time-card">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm font-medium text-gray-700">This Week</p>
                    <p class="text-2xl font-bold text-indigo-700">42.5 hours</p>
                </div>
                <i class="fas fa-calendar-week text-3xl text-indigo-400"></i>
            </div>
        </div>

        <div class="bg-white rounded-xl p-6 time-card">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm font-medium text-gray-700">Avg. Daily</p>
                    <p class="text-2xl font-bold text-green-600">8.5 hours</p>
                </div>
                <i class="fas fa-chart-bar text-3xl text-green-400"></i>
            </div>
        </div>
    </div>
    <!--Calander-->
    {% include 'punch/admin/cal.html' %}
    <!-- Time Entries for Selected Day -->
    <div class="bg-white rounded-xl p-6 time-card">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-semibold text-gray-800"></h3>
            <button class="flex items-center py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                <i class="fas fa-plus mr-2"></i>
                Add Entry
            </button>
        </div>

        <div class="space-y-4">
            <div class="time-entry bg-gray-50 rounded-lg p-4">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <p class="font-medium">Regular Work Hours</p>
                        <p class="text-sm text-gray-500">Submitted at 5:30 PM</p>
                    </div>
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Approved</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <p class="text-xs text-gray-500">Start Time</p>
                        <p class="font-medium">09:15 AM</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500">End Time</p>
                        <p class="font-medium">05:30 PM</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500">Total Hours</p>
                        <p class="font-medium">8.25 hours</p>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-t border-gray-200 flex justify-end space-x-2">
                    <button class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">Edit</button>
                    <button class="text-sm text-gray-500 hover:text-gray-700 font-medium">History</button>
                    <button class="text-sm text-red-600 hover:text-red-800 font-medium">Delete</button>
                </div>
            </div>

            <div class="time-entry bg-gray-50 rounded-lg p-4">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <p class="font-medium">Overtime</p>
                        <p class="text-sm text-gray-500">Submitted at 6:45 PM</p>
                    </div>
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <p class="text-xs text-gray-500">Start Time</p>
                        <p class="font-medium">05:30 PM</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500">End Time</p>
                        <p class="font-medium">07:15 PM</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500">Total Hours</p>
                        <p class="font-medium">1.75 hours</p>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-t border-gray-200 flex justify-end space-x-2">
                    <button class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">Approve</button>
                    <button class="text-sm text-gray-500 hover:text-gray-700 font-medium">Request Edit</button>
                    <button class="text-sm text-red-600 hover:text-red-800 font-medium">Reject</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Function to get initials from a name
        function getInitials(name) {
            if (!name) return "--";
            return name.split(' ').map(n => n[0]).join('').toUpperCase();
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Focus on getting the NEW dropdown working
            loadEmployeesForNewDropdown();
            
            // Listen for tab activation
            document.querySelectorAll('[data-tab="employee-view"]').forEach(tab => {
                tab.addEventListener('click', function() {
                    setTimeout(loadEmployeesForNewDropdown, 100);
                });
            });
            
            // Custom event for admin.html to trigger
            document.getElementById('employee-view').addEventListener('tabActivated', function() {
                console.log('Tab activated event received');
                loadEmployeesForNewDropdown();
            });
        });

        // Function specifically for the new dropdown
        function loadEmployeesForNewDropdown() {
            console.log("Loading employees for dropdown");
            var newDropdown = document.getElementById('new-employee-select');
            
            if (!newDropdown) {
                console.error("Dropdown not found in DOM");
                return;
            }
            
            // Clear any animations or transitions
            newDropdown.style.transition = 'none';
            
            // Make an API request
            fetch('/api/employees/get/')
                .then(function(response) {
                    console.log("Dropdown API response status:", response.status);
                    return response.json();
                })
                .then(function(data) {
                    console.log("Dropdown received data:", data);
                    
                    if (data.success && data.employees && data.employees.length > 0) {
                        // Reset dropdown
                        newDropdown.innerHTML = '<option value="">Choose Employee</option>';
                        
                        // Add each employee
                        data.employees.forEach(function(emp) {
                            var opt = document.createElement('option');
                            opt.value = emp.id;
                            opt.textContent = emp.full_name;
                            newDropdown.appendChild(opt);
                            console.log("Dropdown added option:", opt.outerHTML);
                        });
                        
                        // Flash the dropdown to draw attention
                        newDropdown.style.backgroundColor = '#ffec99';
                        setTimeout(function() {
                            newDropdown.style.transition = 'background-color 1s';
                            newDropdown.style.backgroundColor = '#f3f4ff';
                        }, 500);
                        
                        // Add change event
                        newDropdown.onchange = function() {
                            if (this.value) {
                                // Get the selected employee name directly from the dropdown option
                                const selectedText = this.options[this.selectedIndex].text;
                                
                                // Update the employee name display immediately for better UX
                                const nameElement = document.getElementById('employee-name');
                                const deptElement = document.getElementById('employee-department');
                                const initialsElement = document.getElementById('employee-initials');
                                
                                if (nameElement) {
                                    nameElement.textContent = selectedText;
                                    console.log("Updated employee name to:", selectedText);
                                }
                                
                                // Show loading state for department
                                if (deptElement) {
                                    deptElement.textContent = "Loading...";
                                }
                                
                                // Update initials immediately
                                if (initialsElement) {
                                    initialsElement.textContent = getInitials(selectedText);
                                }
                                
                                // Then load full details
                                loadEmployeeDetailsFromNewDropdown(this.value);
                            } else {
                                // Reset when "Choose Employee" is selected
                                resetEmployeeDisplay();
                            }
                        };
                        
                        console.log("Dropdown setup complete. Current HTML:", newDropdown.outerHTML);
                    } else {
                        console.error("Dropdown: No employees found in API response");
                    }
                })
                .catch(function(error) {
                    console.error("Dropdown error:", error);
                });
        }

        function loadEmployeeDetailsFromNewDropdown(employeeId) {
            console.log("Loading details for employee ID:", employeeId);
            
            fetch('/api/employees/' + employeeId + '/')
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    if (data.success && data.employee) {
                        console.log("Employee details received:", data.employee);
                        console.log("Department value:", data.employee.department);
                        
                        var emp = data.employee;
                        // We already set the name for immediate feedback, but we'll set it again here
                        // in case there's any formatting difference between dropdown and API response
                        document.getElementById('employee-name').textContent = emp.full_name;
                        
                        // IMPORTANT: Force department display with exactly what we received
                        const departmentElement = document.getElementById('employee-department');
                        departmentElement.textContent = emp.department;
                        console.log("Department element updated with:", emp.department);
                        console.log("Department element now contains:", departmentElement.textContent);
                        
                        document.getElementById('employee-initials').textContent = getInitials(emp.full_name);
                        
                        // Update the page title to include employee name
                        document.querySelector('#employee-view h3.text-xl').textContent = emp.full_name;
                        document.querySelector('#dep').textContent = departmentElement.textContent;
                        
                        // Visual feedback of successful data load
                        var initialsElement = document.getElementById('employee-initials');
                        initialsElement.style.transition = 'background-color 0.5s';
                        initialsElement.style.backgroundColor = '#c7f9cc';
                        setTimeout(function() {
                            initialsElement.style.backgroundColor = '';
                        }, 1000);
                    } else {
                        console.error("Failed to load employee details");
                    }
                })
                .catch(function(error) {
                    console.error("Error loading employee details:", error);
                });
        }

        function resetEmployeeDisplay() {
            const nameElement = document.getElementById('employee-name');
            const deptElement = document.getElementById('employee-department');
            const initialsElement = document.getElementById('employee-initials');
            const titleElement = document.querySelector('#employee-view h3.text-xl');

            if (nameElement) nameElement.textContent = 'Select an employee';
            if (deptElement) deptElement.textContent = '--';
            if (initialsElement) initialsElement.textContent = '--';
            if (titleElement) titleElement.textContent = 'Select an employee';
        }

        // Run immediately to populate the dropdown
        setTimeout(loadEmployeesForNewDropdown, 500);
    </script>
</div>
