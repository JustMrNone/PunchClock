{% extends 'base.html' %}

{% block title %}WorkTime Tracker | Calendar{% endblock %}

{% block extra_head %}
<script>
  (function() {
    try {
      const savedTheme = localStorage.getItem('theme') || 'system';
      const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = savedTheme === 'system' ? (systemDark ? 'dark' : 'light') : savedTheme;
      document.documentElement.setAttribute('data-theme', theme);
    } catch (e) {
      console.error('Theme initialization failed:', e);
    }
  })();
</script>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
    
    /* Base theme variables */
    :root {
        --bg-primary: #ffffff;
        --bg-secondary: #f9fafb;
        --bg-card: #ffffff;
        --bg-hover: #f3f4ff;
        --bg-active: #e0e7ff;
        --bg-accent: #eef2ff;
        --text-primary: #111827;
        --text-secondary: #4b5563;
        --text-muted: #6b7280;
        --border-color: #e5e7eb;
        --input-bg: #ffffff;
        --input-border: #d1d5db;
        --shadow-color: rgba(0, 0, 0, 0.1);
        --success-bg: #dcfce7;
        --success-text: #166534;
        --warning-bg: #fef9c3;
        --warning-text: #854d0e;
        --error-bg: #fee2e2;
        --error-text: #991b1b;
    }

    /* Dark mode variables */
    [data-theme='dark'] {
        --bg-primary: #121212;
        --bg-secondary: #1e1e1e;
        --bg-card: #242424;
        --bg-hover: #333333;
        --bg-active: #444444;
        --text-primary: #ffffff;
        --text-secondary: #cccccc;
        --text-muted: #999999;
        --border-color: #444444;
        --input-bg: #1e1e1e;
        --input-border: #555555;
        --shadow-color: rgba(0, 0, 0, 0.7);
        --success-bg: #14532d;
        --success-text: #a7f3d0;
        --warning-bg: #78350f;
        --warning-text: #fcd34d;
        --error-bg: #7f1d1d;
        --error-text: #fca5a5;
    }
    
    body {
        font-family: 'Poppins', sans-serif;
        background-color: var(--bg-secondary);
        color: var(--text-primary);
        transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    .bg-white {
        background-color: var(--bg-card) !important;
    }
    
    .text-gray-800 {
        color: var(--text-primary) !important;
    }
    
    .text-gray-600, .text-gray-700 {
        color: var(--text-secondary) !important;
    }
    
    .text-gray-500 {
        color: var(--text-muted) !important;
    }
    
    .border-gray-200, .border-gray-300 {
        border-color: var(--border-color) !important;
    }
    
    .bg-gray-50, .hover\:bg-gray-50:hover {
        background-color: var(--bg-hover) !important;
    }
    
    .bg-gray-100, .hover\:bg-gray-100:hover {
        background-color: var(--bg-accent) !important;
    }
    
    .hover\:bg-gray-200:hover {
        background-color: var(--bg-active) !important;
    }
    
    /* Calendar specific styles */
    [data-theme='dark'] .calendar-day {
        background-color: var(--bg-card) !important;
        border-color: var(--border-color) !important;
    }
    
    [data-theme='dark'] .calendar-day.bg-red-50 {
        background-color: var(--error-bg) !important;
    }
    
    [data-theme='dark'] #context-menu {
        background-color: var(--bg-card) !important;
    }
    
    [data-theme='dark'] #custom-modal .bg-white {
        background-color: var(--bg-card) !important;
    }
    
    /* Fix calendar navigation buttons in dark mode */
    [data-theme='dark'] .bg-gray-100,
    [data-theme='dark'] button.bg-gray-100 {
        background-color: var(--bg-hover) !important;
        color: var(--text-primary) !important;
    }
    
    [data-theme='dark'] .hover\:bg-gray-200:hover,
    [data-theme='dark'] button.hover\:bg-gray-200:hover {
        background-color: var(--bg-active) !important;
    }
    
    /* Fix calendar icon */
    [data-theme='dark'] .fa-calendar-alt,
    [data-theme='dark'] .fa-chevron-left,
    [data-theme='dark'] .fa-chevron-right {
        color: var(--text-primary) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-12 max-w-4xl">  <!-- increased py-8 to py-12 -->
    <!-- Header -->
    <header class="flex justify-between items-center mb-12">  <!-- increased mb-8 to mb-12 -->
        <div>
            <h1 class="text-3xl font-bold text-gray-800">Calendar</h1>
            <p class="text-gray-600">Track your schedule and add personal notes</p>
        </div>
        <div class="flex items-center space-x-4">
            <button class="p-2 bg-gray-100 rounded-lg hover:bg-gray-200">
                <i class="fas fa-calendar-alt"></i>
            </button>
            <a href="{% url 'PunchClock:punchclock' %}" class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-colors">
                <i class="fas fa-clock mr-2"></i>Punch Card
            </a>
        </div>
    </header>

    <!-- Calendar Component -->
    <div class="bg-white rounded-xl p-6 mb-8 time-card">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-semibold text-gray-800 date"></h3>
            <div class="flex space-x-2">
                <button class="p-2 bg-gray-100 rounded-lg hover:bg-gray-200">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 text-sm font-medium">
                    This Month
                </button>
                <button class="p-2 bg-gray-100 rounded-lg hover:bg-gray-200">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- Day Labels -->
        <div class="grid grid-cols-7 gap-2 mb-2">
            <div class="text-center text-sm font-medium text-gray-600">Sun</div>
            <div class="text-center text-sm font-medium text-gray-600">Mon</div>
            <div class="text-center text-sm font-medium text-gray-600">Tue</div>
            <div class="text-center text-sm font-medium text-gray-600">Wed</div>
            <div class="text-center text-sm font-medium text-gray-600">Thu</div>
            <div class="text-center text-sm font-medium text-gray-600">Fri</div>
            <div class="text-center text-sm font-medium text-gray-600">Sat</div>
        </div>

        <div id="calendar-grid" class="grid grid-cols-7 gap-2">
            <!-- Calendar days will be dynamically rendered here -->
        </div>

        <!-- Context Menu - Only for personal notes -->
        <div id="context-menu" class="hidden absolute bg-white shadow-md rounded-lg p-2 z-50">
            <button id="add-personal-note" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Add Personal Note</button>
            <button id="remove-personal-note" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Remove Personal Note</button>
        </div>
    </div>

    <!-- Note Modal -->
    <div id="custom-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-lg p-6 w-96">
            <h3 id="modal-title" class="text-lg font-semibold text-gray-800 mb-4">Add Personal Note</h3>
            <form id="modal-form">
                <div class="mb-4">
                    <label for="modal-input" class="block text-sm font-medium text-gray-700">Details</label>
                    <textarea id="modal-input" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" rows="3"></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="modal-cancel" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const calendarGrid = document.getElementById('calendar-grid');
        const contextMenu = document.getElementById('context-menu');
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalInput = document.getElementById('modal-input');
        const modalForm = document.getElementById('modal-form');
        const modalCancel = document.getElementById('modal-cancel');
        const todayBtn = document.querySelector('.fa-calendar-alt').parentElement;
        const dateDisplay = document.querySelector('.date');
        let selectedDate = null;
        let currentDisplayMonth = new Date().getMonth();
        let currentDisplayYear = new Date().getFullYear();

        // Initialize state
        let holidays = {};
        let globalNotes = {};
        let personalNotes = {};
        let weekendDays = [];

        // Load calendar settings and personal notes from backend
        Promise.all([
            fetch('/api/calendar-settings/get/'),
            fetch('/api/personal-notes/get/')
        ])
        .then(responses => Promise.all(responses.map(r => r.json())))
        .then(([calendarData, personalData]) => {
            if (calendarData.success) {
                holidays = calendarData.holidays || {};
                globalNotes = calendarData.notes || {};
                weekendDays = (calendarData.weekendDays || []).map(day => Number(day)); // Convert to numbers
            }
            if (personalData.success) {
                personalNotes = personalData.notes || {};
            }
            renderCalendar(currentDisplayYear, currentDisplayMonth);
        })
        .catch(error => {
            console.error('Error loading calendar data:', error);
            renderCalendar(currentDisplayYear, currentDisplayMonth);
        });

        document.addEventListener('click', function(e) {
            if (!e.target.closest('#context-menu') && !e.target.closest('#custom-modal')) {
                hideContextMenu();
            }
        });

        document.addEventListener('contextmenu', function (e) {
            if (e.target.closest('.calendar-day')) {
                e.preventDefault();
                const dayCell = e.target.closest('.calendar-day');
                selectedDate = dayCell.dataset.date;
                const rect = dayCell.getBoundingClientRect();
                showContextMenu(rect.left + window.scrollX, rect.top + window.scrollY);
            } else {
                hideContextMenu();
            }
        });

        function showContextMenu(x, y) {
            contextMenu.style.display = 'block';
            contextMenu.style.left = `${x}px`;
            contextMenu.style.top = `${y}px`;
        }

        function hideContextMenu() {
            contextMenu.style.display = 'none';
        }

        function showModal(title, placeholder, callback) {
            modalTitle.textContent = title;
            modalInput.value = placeholder || '';
            modal.style.display = 'flex';

            const handleSubmit = function(e) {
                e.preventDefault();
                callback(modalInput.value);
                modal.style.display = 'none';
                modalForm.removeEventListener('submit', handleSubmit);
            };

            const handleCancel = function() {
                modal.style.display = 'none';
                modalForm.removeEventListener('submit', handleSubmit);
                modalCancel.removeEventListener('click', handleCancel);
            };

            modalForm.addEventListener('submit', handleSubmit);
            modalCancel.addEventListener('click', handleCancel);
        }

        function updateDateDisplay(date) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            dateDisplay.textContent = date.toLocaleDateString('en-US', options);
        }

        function savePersonalNote() {
            console.log('Saving personal note:', personalNotes);
            
            fetch('/api/personal-notes/update/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    notes: personalNotes
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Show success notification
                    showNotification('Note saved successfully!');
                } else {
                    console.error('Error saving personal note:', data.message);
                    showNotification('Failed to save note!', 'error');
                }
            })
            .catch(error => {
                console.error('Error saving personal note:', error);
                showNotification('Failed to save note!', 'error');
            });
        }

        // Function to show notification
        function showNotification(message, type = 'success') {
            // Create notification element if it doesn't exist
            let notification = document.getElementById('notification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'notification';
                notification.style.position = 'fixed';
                notification.style.bottom = '20px';
                notification.style.right = '20px';
                notification.style.padding = '10px 20px';
                notification.style.borderRadius = '4px';
                notification.style.color = 'white';
                notification.style.fontWeight = '500';
                notification.style.zIndex = '9999';
                notification.style.transition = 'transform 0.3s ease-out';
                document.body.appendChild(notification);
            }

            // Set color based on type
            notification.style.backgroundColor = type === 'success' ? '#10b981' : '#ef4444';
            notification.textContent = message;
            
            // Show notification
            notification.style.transform = 'translateY(0)';
            
            // Hide after 3 seconds
            setTimeout(() => {
                notification.style.transform = 'translateY(100px)';
            }, 3000);
        }

        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        function saveCalendarSettings() {
            fetch('/api/calendar-settings/update/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    holidays: holidays,
                    notes: globalNotes,
                    weekendDays: weekendDays
                })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    console.error('Error saving calendar settings:', data.message);
                }
            })
            .catch(error => console.error('Error saving calendar settings:', error));
        }
        function renderCalendar(year, month) {
            calendarGrid.innerHTML = '';
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Update the month/year display
            const monthYearDisplay = document.querySelector('.date');
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            monthYearDisplay.textContent = `${months[month]} ${year}`;

            // Add empty cells for days before the first day of the month
            for (let i = 0; i < firstDayOfMonth; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.classList.add('h-20', 'p-1', 'text-right');
                calendarGrid.appendChild(emptyCell);
            }

            // Create calendar days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.classList.add('h-20', 'p-1', 'text-right', 'calendar-day', 'cursor-pointer', 'border', 'border-gray-200', 'relative', 'rounded-lg', 'transition-all', 'duration-200');

                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const date = new Date(year, month, day);
                date.setHours(0, 0, 0, 0);
                const dayOfWeek = date.getDay();
                dayCell.dataset.date = dateString;

                // Add day of week label
                const dayLabel = document.createElement('div');
                dayLabel.classList.add('text-xs', 'text-gray-500', 'absolute', 'top-1', 'left-2');
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                dayLabel.textContent = days[dayOfWeek];
                dayCell.appendChild(dayLabel);

                // Add click handler for date selection
                dayCell.addEventListener('click', function() {
                    document.querySelectorAll('.calendar-day').forEach(d => {
                        d.classList.remove('selected');
                        d.classList.remove('bg-indigo-50');
                        d.classList.remove('ring-2');
                        d.classList.remove('ring-indigo-600');
                        d.classList.remove('ring-offset-2');
                    });
                    this.classList.add('selected', 'bg-indigo-50', 'ring-2', 'ring-indigo-600', 'ring-offset-2');
                    selectedDate = dateString;
                    updateDateDisplay(new Date(dateString));
                });

                // Highlight today's date
                if (date.getTime() === today.getTime()) {
                    dayCell.classList.add('ring-2', 'ring-indigo-600', 'ring-offset-2', 'bg-indigo-50');
                    dayCell.classList.add('selected');
                    selectedDate = dateString;
                    updateDateDisplay(today);
                }
                
                // Apply weekend styling
                if (weekendDays.includes(dayOfWeek)) {
                    dayCell.classList.add('bg-red-50');
                }
                
                // Apply holiday styling (same as weekends)
                if (holidays[dateString]) {
                    dayCell.classList.add('bg-red-50');
                }

                // Create day number container
                const dayContent = document.createElement('div');
                dayContent.classList.add('text-sm', 'font-medium', 'mt-4', 'mr-2');
                dayContent.textContent = day;
                dayCell.appendChild(dayContent);

                // Add holiday indication if exists
                if (holidays[dateString]) {
                    const holidayContent = document.createElement('div');
                    holidayContent.classList.add('text-xs', 'text-red-500', 'mt-1');
                    holidayContent.textContent = holidays[dateString];
                    dayCell.appendChild(holidayContent);
                }

                // Add global note if exists
                if (globalNotes[dateString]) {
                    const globalNoteContent = document.createElement('div');
                    globalNoteContent.classList.add('text-xs', 'text-blue-500', 'mt-1');
                    globalNoteContent.textContent = globalNotes[dateString];
                    dayCell.appendChild(globalNoteContent);
                }

                // Add personal note if exists
                if (personalNotes[dateString]) {
                    const personalNoteContent = document.createElement('div');
                    personalNoteContent.classList.add('text-xs', 'text-green-500', 'mt-1');
                    personalNoteContent.textContent = personalNotes[dateString];
                    dayCell.appendChild(personalNoteContent);
                }

                calendarGrid.appendChild(dayCell);
            }
        }

        // Handle month navigation
        document.querySelector('.fa-chevron-left').parentElement.addEventListener('click', function() {
            currentDisplayMonth--;
            if (currentDisplayMonth < 0) {
                currentDisplayMonth = 11;
                currentDisplayYear--;
            }
            renderCalendar(currentDisplayYear, currentDisplayMonth);
        });

        document.querySelector('.fa-chevron-right').parentElement.addEventListener('click', function() {
            currentDisplayMonth++;
            if (currentDisplayMonth > 11) {
                currentDisplayMonth = 0;
                currentDisplayYear++;
            }
            renderCalendar(currentDisplayYear, currentDisplayMonth);
        });

        // Handle Today button click
        todayBtn.addEventListener('click', function() {
            const today = new Date();
            currentDisplayMonth = today.getMonth();
            currentDisplayYear = today.getFullYear();
            renderCalendar(currentDisplayYear, currentDisplayMonth);
        });

        // Handle personal note addition
        document.getElementById('add-personal-note').addEventListener('click', function() {
            hideContextMenu();
            showModal('Add Personal Note', personalNotes[selectedDate] || '', function(note) {
                if (note.trim()) {
                    personalNotes[selectedDate] = note;
                    savePersonalNote();
                    renderCalendar(currentDisplayYear, currentDisplayMonth);
                }
            });
        });

        // Handle personal note removal
        document.getElementById('remove-personal-note').addEventListener('click', function() {
            hideContextMenu();
            if (personalNotes[selectedDate]) {
                delete personalNotes[selectedDate];
                savePersonalNote();
                showNotification('Note removed successfully!');
                renderCalendar(currentDisplayYear, currentDisplayMonth);
            } else {
                showNotification('No note to remove', 'error');
            }
        });

        // Initial render
        renderCalendar(currentDisplayYear, currentDisplayMonth);
    });
</script>
{% endblock %}